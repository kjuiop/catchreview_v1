<!DOCTYPE html>
<html lang="en"
      xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="~{layout}">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
</head>
<body>
<div layout:fragment="content">
    <div th:replace="layout/fragments.html :: header(false)"></div>
    <main class="flex-shrink-0 bg-light mt-5">
        <!-- Page content-->
        <section class="mt-3">
            <div class="container px-5">
                <!-- Contact form-->
                <div class="rounded-3 py-5 px-md-5">
                    <div class="text-center mb-5">
                        <h1 class="fw-bolder">Î¶¨Î∑∞ ÏûëÏÑ±</h1>
                        <p class="lead fw-normal text-muted mb-0">ÎÇòÎÇ†Ïùò Í∏∞ÏñµÎì§ÏùÑ Í∏∞Î°ùÌï¥Î≥¥ÏÑ∏ÏöîüóΩ</p>
                    </div>
                    <div class="row gx-5 justify-content-center">
                        <div class="col-lg-8 col-xl-6">
                            <form id="reviewCreateForm" class="needs-validation" name="reviewCreateForm" th:action="|/mark/${reviewCreateForm.markDetailId}/store/review/create|" th:object="${reviewCreateForm}" method="post" novalidate>
                                <input type="hidden" name="markDetailId" th:field="*{markDetailId}" />

<!--                                <div class="form-group mb-4">-->
<!--                                    <label class="mb-1" for="title">Ï†úÎ™©</label>-->
<!--                                    <input id="title" th:field="*{title}" type="text" class="form-control" name="title"-->
<!--                                           aria-describedby="contactHelp" required max="500" placeholder="Î¶¨Î∑∞ Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.">-->
<!--                                    <small class="invalid-feedback">Î¶¨Î∑∞ Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</small>-->
<!--                                    <small class="form-text text-danger" th:if="${#fields.hasErrors('title')}" th:errors="*{title}">Title Error</small>-->
<!--                                </div>-->

                                <div class="form-group mb-4">
                                    <label class="mb-1" for="carouselExampleControls">Ïù¥ÎØ∏ÏßÄ</label>
                                    <div class="thumbnailWrapper attachment display-flex-column">
                                        <div class="thumbnailBtnSite">
                                            <button id="attachFile" type="button" class="btn btn-outline-primary thumbnailUpload" style="font-size: 12px;">
                                                <i class="fas fa-file-image-o" aria-hidden="true"></i>
                                                ÏóÖÎ°úÎìú
                                            </button>
                                        </div>
                                        <div id="carouselExampleControls" class="carousel slide mt-3" data-bs-ride="carousel" data-bs-interval="false">
                                            <div class="carousel-inner imagePanel">
                                            </div>
                                            <button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="prev">
                                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Previous</span>
                                            </button>
                                            <button class="carousel-control-next" type="button" data-bs-target="#carouselExampleControls" data-bs-slide="next">
                                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                                <span class="visually-hidden">Next</span>
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <div class="form-group mb-3">
                                    <label for="content">ÎÇ¥Ïö©</label>
                                    <textarea id="content" th:field="*{content}" class="form-control" rows="7" name="content"
                                              placeholder="Î¶¨Î∑∞Î•º Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî." aria-describedby="contentHelp" required></textarea>
                                    <small class="form-text text-danger" th:if="${#fields.hasErrors('content')}" th:errors="*{content}">Content Error</small>
                                </div>

                                <div class="d-grid"><button class="btn btn-primary btn-lg btnSubmit" type="button">ÏûëÏÑ±ÌïòÍ∏∞</button></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

<section layout:fragment="script">
    <script th:replace="layout/fragments :: attachment"></script>
    <script>

        const onReady = function() {

        }

        const imgUpload = function() {
            const $this = $(this);

            documentUpload({
                multiple: false,
                callback: function (data) {

                    console.log("data", data);

                    if (data.status === 200) {

                        const   fullPath            = data.responseText,
                                $thumbnailWrapper   = $this.closest('.thumbnailWrapper'),
                                $thumbnailPanel     = $thumbnailWrapper.find('.imagePanel');

                        let tag                     = drawSlideImgTag(fullPath);

                        $thumbnailPanel.append(tag);

                        $('.carousel-item').removeClass('active');
                        $('.carousel-item').last().addClass('active');
                    }
                }
            });
        };

        const drawSlideImgTag = function(fullPath) {
            let tag = '';

            tag += '<div class="card carousel-item">';
            tag +=      '<img src="' + fullPath + '" class="d-block w-100 card-img-top" style="height: 200px;">';
            tag +=          '<div class="card-body">';
            tag +=              '<textarea class="form-control" rows="5" name="reviewText"></textarea>';
            tag +=          '</div>';
            tag += '</div>';

            return tag;
        };

        const save = function() {

            const   $form           = $('form[name="reviewCreateForm"]'),
                    markDetailId    = $form.find('input[name="markDetailId"]').val();

            let param = {
                "markDetailId"    : markDetailId,
                "content"         : $form.find('textarea[name="content"]').val(),
            }

            let reviewCardList = [];

            $('.imagePanel .carousel-item').each(function(idx, item){

                const me = $(item);

                let imgData = {
                    "reviewImg"   : me.find('img').attr('src'),
                    "reviewText"  : me.find('textarea').val()
                }

                reviewCardList.push(imgData);
            });

            if (reviewCardList.length > 0) {
                param['bannerImg'] = reviewCardList[0].reviewImg;
            }

            param['reviewCardList'] = reviewCardList;

            console.log("params", param);

            $.ajax({
                url: "/mark/" + markDetailId + "/store/review/create",
                method: 'post',
                type: "json",
                contentType: "application/json",
                data: JSON.stringify(param),
                success: function (result) {
                    location.reload();
                },
                error:function(error){
                    ajaxErrorFieldByText(error);
                }
            });

        }

        $(document).ready(onReady)
            .on('click', '.thumbnailUpload', imgUpload)
            .on('click', '.btnSubmit', save)
        ;
    </script>
</section>
</body>
</html>
